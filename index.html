<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ゴルフ オリンピック スコアボード</title>
    <!-- Tailwind CSS CDNを読み込みます。これにより、モダンなデザインを素早く適用できます。 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interフォントを適用 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* カスタムスタイル */
        .score-table-container {
            max-height: 60vh; /* テーブルの高さを制限し、スクロール可能にする */
            overflow-y: auto; /* 縦スクロールを有効にする */
            -webkit-overflow-scrolling: touch; /* iOSでのスムーズなスクロール */
        }
        /* stickyヘッダーのためのスタイル */
        .score-table thead th {
            position: sticky;
            top: 0;
            background-color: #f3f4f6; /* ヘッダーの背景色 */
            z-index: 10; /* 他の要素の上に表示 */
        }
        /* プラスの差分は緑色 */
        .positive-diff {
            color: #28a745;
            font-weight: bold;
        }
        /* マイナスの差分は赤色 */
        .negative-diff {
            color: #dc3545;
            font-weight: bold;
        }
        /* ゼロの差分は灰色 */
        .zero-diff {
            color: #6c757d;
        }

        /* モーダルオーバーレイのスタイル */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        /* モーダル内のボタン */
        .modal-button {
            @apply bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out;
        }
        .modal-button.clear {
            @apply bg-gray-400 hover:bg-gray-500;
        }
        .modal-button.cancel {
            @apply bg-red-500 hover:bg-red-600;
        }
        .modal-button.save {
            @apply bg-green-500 hover:bg-green-600;
        }

        /* カスタム確認モーダルのスタイル */
        #confirmModal .modal-content {
            width: 300px; /* 小さめに設定 */
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4">
    <header class="bg-blue-800 text-white p-6 rounded-lg shadow-md mb-6 text-center relative">
        <h1 class="text-4xl font-bold mb-2">ゴルフ オリンピック スコアボード</h1>
        <p class="text-lg opacity-90">18ホールのメダル点数を記録し、合計点数と得点差を計算します。</p>
        <button id="settings-button" class="absolute top-4 right-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm">
            設定
        </button>
    </header>

    <main class="max-w-6xl mx-auto">
        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold text-blue-700 border-b-2 border-blue-200 pb-3 mb-5">プレイヤー人数設定</h2>
            <div class="flex justify-center gap-6 mb-5">
                <label class="inline-flex items-center">
                    <input type="radio" name="player-count" value="2" class="form-radio h-5 w-5 text-blue-600" checked>
                    <span class="ml-2 text-lg font-medium">2人</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="player-count" value="3" class="form-radio h-5 w-5 text-blue-600">
                    <span class="ml-2 text-lg font-medium">3人</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="player-count" value="4" class="form-radio h-5 w-5 text-blue-600">
                    <span class="ml-2 text-lg font-medium">4人</span>
                </label>
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold text-blue-700 border-b-2 border-blue-200 pb-3 mb-5">プレイヤー名設定</h2>
            <div id="player-name-inputs-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-5">
                <!-- プレイヤー名入力フィールドはJavaScriptで動的に表示/非表示されます -->
                <div class="flex flex-col player-input-wrapper" data-player-id="0">
                    <label for="player1-name" class="mb-1 font-medium">プレイヤー1:</label>
                    <input type="text" id="player1-name" placeholder="プレイヤーA" value="プレイヤーA"
                           class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex flex-col player-input-wrapper" data-player-id="1">
                    <label for="player2-name" class="mb-1 font-medium">プレイヤー2:</label>
                    <input type="text" id="player2-name" placeholder="プレイヤーB" value="プレイヤーB"
                           class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex flex-col player-input-wrapper" data-player-id="2">
                    <label for="player3-name" class="mb-1 font-medium">プレイヤー3:</label>
                    <input type="text" id="player3-name" placeholder="プレイヤーC" value="プレイヤーC"
                           class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex flex-col player-input-wrapper" data-player-id="3">
                    <label for="player4-name" class="mb-1 font-medium">プレイヤー4:</label>
                    <input type="text" id="player4-name" placeholder="プレイヤーD" value="プレイヤーD"
                           class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold text-blue-700 border-b-2 border-blue-200 pb-3 mb-5">各ホール スコア入力</h2>
            <p class="text-gray-600 mb-4 italic">編集したいホールとプレイヤーのセルをタップしてください。</p>
            <div class="score-table-container border border-gray-200 rounded-md">
                <table id="score-table" class="min-w-full divide-y divide-gray-200 score-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hole</th>
                            <!-- プレイヤー名ヘッダーはJavaScriptで更新されます -->
                            <th class="player-name-header px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-player-id="0"></th>
                            <th class="player-name-header px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-player-id="1"></th>
                            <th class="player-name-header px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-player-id="2"></th>
                            <th class="player-name-header px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-player-id="3"></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- JavaScriptで18ホール分の行を生成します -->
                    </tbody>
                </table>
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold text-blue-700 border-b-2 border-blue-200 pb-3 mb-5">結果</h2>
            <div class="overflow-x-auto">
                <table id="results-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">プレイヤー</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">合計点数</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">得点差</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- JavaScriptで結果を生成します -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-center mt-8">
                <button id="reset-button"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    スコアをリセット
                </button>
            </div>
        </section>
    </main>

    <footer class="text-center text-gray-600 mt-8 p-4">
        <p>&copy; 2025 ゴルフオリンピック スコアボード</p>
    </footer>

    <!-- メダル選択モーダル -->
    <div id="medalSelectModal" class="modal-overlay">
        <div class="modal-content w-80">
            <h3 id="medalSelectModalTitle" class="text-xl font-semibold mb-4 text-center">ホール ? - プレイヤー ?</h3>
            <div class="grid grid-cols-2 gap-3">
                <button class="modal-button" data-medal="チップイン">チップイン (5点)</button>
                <button class="modal-button" data-medal="金">金 (4点)</button>
                <button class="modal-button" data-medal="銀">銀 (3点)</button>
                <button class="modal-button" data-medal="銅">銅 (2点)</button>
                <button class="modal-button" data-medal="鉄">鉄 (1点)</button>
                <button class="modal-button clear" data-medal="">クリア</button>
            </div>
            <div class="flex justify-end mt-6">
                <button id="closeMedalSelectModal" class="modal-button cancel">閉じる</button>
            </div>
        </div>
    </div>

    <!-- 設定モーダル -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content w-96">
            <h3 class="text-xl font-semibold mb-4 text-center">メダル点数設定</h3>
            <div class="grid grid-cols-1 gap-4 mb-6">
                <div class="flex items-center">
                    <label for="points-チップイン" class="w-1/2 font-medium">チップイン:</label>
                    <input type="number" id="points-チップイン" class="w-1/2 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center">
                    <label for="points-金" class="w-1/2 font-medium">金:</label>
                    <input type="number" id="points-金" class="w-1/2 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center">
                    <label for="points-銀" class="w-1/2 font-medium">銀:</label>
                    <input type="number" id="points-銀" class="w-1/2 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center">
                    <label for="points-銅" class="w-1/2 font-medium">銅:</label>
                    <input type="number" id="points-銅" class="w-1/2 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center">
                    <label for="points-鉄" class="w-1/2 font-medium">鉄:</label>
                    <input type="number" id="points-鉄" class="w-1/2 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button id="saveSettings" class="modal-button save">保存</button>
                <button id="closeSettingsModal" class="modal-button cancel">閉じる</button>
            </div>
        </div>
    </div>

    <!-- カスタム確認モーダル -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">確認</h3>
            <p id="confirmMessage" class="mb-6">本当に実行しますか？</p>
            <div class="flex justify-center gap-4">
                <button id="confirmYes" class="modal-button save">はい</button>
                <button id="confirmNo" class="modal-button cancel">いいえ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const MAX_PLAYERS = 4; // 最大プレイヤー数
            const NUM_HOLES = 18;
            const LOCAL_STORAGE_KEY_SCORES = 'golfOlympicScores';
            const LOCAL_STORAGE_KEY_POINTS = 'golfOlympicMedalPoints';
            const LOCAL_STORAGE_KEY_PLAYER_COUNT = 'golfOlympicPlayerCount';

            // デフォルトのメダル点数定義
            const DEFAULT_MEDAL_POINTS = {
                '': 0, // 未選択の場合
                '選択してください': 0, // ドロップダウンの初期選択肢
                'チップイン': 5,
                '金': 4,
                '銀': 3,
                '銅': 2,
                '鉄': 1
            };
            let currentMedalPoints = {}; // 現在のメダル点数 (動的に変更可能)
            let currentPlayerCount = 4; // 現在のプレイヤー数 (デフォルトは4人)

            // DOM要素の取得
            const playerCountRadios = document.querySelectorAll('input[name="player-count"]');
            const playerInputs = [];
            for (let i = 1; i <= MAX_PLAYERS; i++) {
                playerInputs.push(document.getElementById(`player${i}-name`));
            }
            const playerInputWrappers = document.querySelectorAll('.player-input-wrapper'); // プレイヤー名入力欄のラッパー
            const scoreTableBody = document.querySelector('#score-table tbody');
            const resultsTableBody = document.querySelector('#results-table tbody');
            const playerNameHeaders = document.querySelectorAll('.player-name-header');
            const resetButton = document.getElementById('reset-button');
            const settingsButton = document.getElementById('settings-button');

            // メダル選択モーダル要素
            const medalSelectModal = document.getElementById('medalSelectModal');
            const medalSelectModalTitle = document.getElementById('medalSelectModalTitle');
            const closeMedalSelectModalButton = document.getElementById('closeMedalSelectModal');
            let currentSelectedCell = null; // 現在編集中のセルを保持

            // 設定モーダル要素
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsModalButton = document.getElementById('closeSettingsModal');
            const saveSettingsButton = document.getElementById('saveSettings');
            const medalPointInputs = {};
            Object.keys(DEFAULT_MEDAL_POINTS).forEach(medal => {
                if (medal !== '' && medal !== '選択してください') {
                    medalPointInputs[medal] = document.getElementById(`points-${medal}`);
                }
            });

            // カスタム確認モーダル要素
            const confirmModal = document.getElementById('confirmModal');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmYesButton = document.getElementById('confirmYes');
            const confirmNoButton = document.getElementById('confirmNo');

            // 初期スコアデータ構造
            let scores = {
                playerNames: [],
                holeScores: Array(NUM_HOLES).fill(null).map(() => Array(MAX_PLAYERS).fill('')) // 最大プレイヤー数で初期化
            };

            /**
             * LocalStorageからスコアデータ、メダル点数データ、プレイヤー人数データをロードする
             */
            function loadData() {
                // プレイヤー人数データのロード
                const storedPlayerCount = localStorage.getItem(LOCAL_STORAGE_KEY_PLAYER_COUNT);
                if (storedPlayerCount) {
                    currentPlayerCount = parseInt(storedPlayerCount);
                    // ラジオボタンを更新
                    playerCountRadios.forEach(radio => {
                        if (parseInt(radio.value) === currentPlayerCount) {
                            radio.checked = true;
                        }
                    });
                } else {
                    // デフォルトの4人を選択
                    playerCountRadios[2].checked = true; // 4人のラジオボタン
                }

                // スコアデータのロード
                const storedScores = localStorage.getItem(LOCAL_STORAGE_KEY_SCORES);
                if (storedScores) {
                    scores = JSON.parse(storedScores);
                    // プレイヤー名をUIに反映
                    scores.playerNames.forEach((name, index) => {
                        if (playerInputs[index]) {
                            playerInputs[index].value = name;
                        }
                    });
                    // holeScoresのデータ構造が古い場合や不完全な場合の対策
                    if (!scores.holeScores || scores.holeScores.length !== NUM_HOLES || scores.holeScores[0].length !== MAX_PLAYERS) {
                        // データ構造が合わない場合は初期化 (既存のデータを失う可能性あり)
                        scores.holeScores = Array(NUM_HOLES).fill(null).map(() => Array(MAX_PLAYERS).fill(''));
                    }
                } else {
                    // デフォルトのプレイヤー名を設定
                    playerInputs.forEach((input, index) => {
                        input.value = `プレイヤー${String.fromCharCode(65 + index)}`; // プレイヤーA, B, C, D
                        scores.playerNames[index] = input.value;
                    });
                }

                // メダル点数データのロード
                const storedPoints = localStorage.getItem(LOCAL_STORAGE_KEY_POINTS);
                if (storedPoints) {
                    currentMedalPoints = JSON.parse(storedPoints);
                    // デフォルト値にない新しいメダルが追加された場合や、削除された場合の対策
                    Object.keys(DEFAULT_MEDAL_POINTS).forEach(medal => {
                        if (medal !== '' && medal !== '選択してください' && currentMedalPoints[medal] === undefined) {
                            currentMedalPoints[medal] = DEFAULT_MEDAL_POINTS[medal];
                        }
                    });
                } else {
                    currentMedalPoints = { ...DEFAULT_MEDAL_POINTS }; // デフォルト値をコピー
                }
            }

            /**
             * スコアデータ、メダル点数データ、プレイヤー人数データをLocalStorageに保存する
             */
            function saveData() {
                // 現在のプレイヤー名をscoresオブジェクトに反映
                scores.playerNames = playerInputs.map(input => input.value);
                localStorage.setItem(LOCAL_STORAGE_KEY_SCORES, JSON.stringify(scores));
                localStorage.setItem(LOCAL_STORAGE_KEY_POINTS, JSON.stringify(currentMedalPoints));
                localStorage.setItem(LOCAL_STORAGE_KEY_PLAYER_COUNT, currentPlayerCount.toString());
            }

            /**
             * プレイヤー名入力欄の表示/非表示を切り替える
             */
            function updatePlayerInputVisibility() {
                playerInputWrappers.forEach((wrapper, index) => {
                    if (index < currentPlayerCount) {
                        wrapper.style.display = 'flex'; // 表示
                    } else {
                        wrapper.style.display = 'none'; // 非表示
                    }
                });
            }

            /**
             * スコア入力テーブルを生成・更新する
             */
            function generateScoreTable() {
                scoreTableBody.innerHTML = ''; // 一度クリア

                // プレイヤー名ヘッダーを更新し、表示/非表示を切り替える
                playerNameHeaders.forEach((header, index) => {
                    if (index < currentPlayerCount) {
                        header.textContent = playerInputs[index].value || `プレイヤー${index + 1}`;
                        header.style.display = ''; // 表示
                    } else {
                        header.style.display = 'none'; // 非表示
                    }
                });

                for (let i = 0; i < NUM_HOLES; i++) {
                    const row = scoreTableBody.insertRow();
                    row.classList.add('hover:bg-gray-50'); // ホバーエフェクト
                    const holeCell = row.insertCell();
                    holeCell.textContent = `Hole ${i + 1}`;
                    holeCell.classList.add('px-3', 'py-2', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900', 'text-center');

                    for (let j = 0; j < MAX_PLAYERS; j++) { // MAX_PLAYERSでループ
                        const cell = row.insertCell();
                        cell.classList.add('px-3', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-gray-700', 'text-center', 'cursor-pointer', 'rounded-md', 'hover:bg-blue-100', 'transition-colors');
                        cell.dataset.hole = i;
                        cell.dataset.player = j;

                        if (j < currentPlayerCount) { // 現在のプレイヤー数に基づいて表示/非表示
                            cell.textContent = scores.holeScores[i][j] || '-'; // 初期表示は空白またはメダル名

                            // クリックイベントリスナーを設定
                            cell.addEventListener('click', (event) => {
                                currentSelectedCell = event.target; // 現在編集中のセルを保存
                                const holeIndex = parseInt(event.target.dataset.hole);
                                const playerIndex = parseInt(event.target.dataset.player);
                                const playerName = playerInputs[playerIndex].value || `プレイヤー${playerIndex + 1}`;
                                medalSelectModalTitle.textContent = `ホール ${holeIndex + 1} - ${playerName}`;
                                showModal(medalSelectModal);
                            });
                            // 既存のメダルがあればクラスを追加して色付けなど
                            const currentMedal = scores.holeScores[i][j];
                            cell.classList.remove('bg-yellow-100', 'bg-amber-100', 'bg-gray-200', 'bg-orange-100', 'bg-red-100'); // 一度クリア
                            if (currentMedal === 'チップイン') cell.classList.add('bg-yellow-100');
                            else if (currentMedal === '金') cell.classList.add('bg-amber-100');
                            else if (currentMedal === '銀') cell.classList.add('bg-gray-200');
                            else if (currentMedal === '銅') cell.classList.add('bg-orange-100');
                            else if (currentMedal === '鉄') cell.classList.add('bg-red-100');
                            cell.style.display = ''; // 表示
                        } else {
                            cell.style.display = 'none'; // 非表示
                        }
                    }
                }
            }

            /**
             * 結果（合計点数と得点差）を計算して表示する
             */
            function updateResults() {
                resultsTableBody.innerHTML = ''; // 一度クリア

                const playerTotals = Array(MAX_PLAYERS).fill(0); // 最大プレイヤー数で配列を確保

                // 各プレイヤーの合計点数を計算
                for (let i = 0; i < NUM_HOLES; i++) {
                    for (let j = 0; j < currentPlayerCount; j++) { // 現在のプレイヤー数でループ
                        const medalType = scores.holeScores[i][j];
                        playerTotals[j] += currentMedalPoints[medalType] || 0; // 現在のメダル点数を使用
                    }
                }

                // 結果テーブルに表示
                for (let index = 0; index < currentPlayerCount; index++) { // 現在のプレイヤー数でループ
                    const playerName = playerInputs[index].value || `プレイヤー${index + 1}`;
                    const totalScore = playerTotals[index];
                    
                    let difference = 0;
                    if (currentPlayerCount > 1) {
                        // 他のプレイヤーの点数合計を計算
                        let otherPlayersScoreSum = 0;
                        for (let k = 0; k < currentPlayerCount; k++) {
                            if (k !== index) { // 本人以外のプレイヤーの点数を合計
                                otherPlayersScoreSum += playerTotals[k];
                            }
                        }
                        // 新しい計算式: (本人の点数 × (人数設定 - 1)) - (他人の点数合計)
                        difference = (totalScore * (currentPlayerCount - 1)) - otherPlayersScoreSum;
                    }
                    // 1人の場合は差分は0とするか、表示しない

                    const row = resultsTableBody.insertRow();
                    row.classList.add('hover:bg-gray-50'); // ホバーエフェクト
                    
                    // プレイヤー名セル
                    const nameCell = row.insertCell();
                    nameCell.textContent = playerName;
                    nameCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900');

                    // 合計点数セル
                    const totalCell = row.insertCell();
                    totalCell.textContent = totalScore;
                    totalCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500', 'text-center');

                    // 差分セル
                    const diffCell = row.insertCell();
                    diffCell.textContent = difference > 0 ? `+${difference}` : difference;
                    diffCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-center');

                    if (difference > 0) {
                        diffCell.classList.add('positive-diff');
                    } else if (difference < 0) {
                        diffCell.classList.add('negative-diff');
                    } else {
                        diffCell.classList.add('zero-diff');
                    }
                }
            }

            /**
             * モーダルを表示する
             * @param {HTMLElement} modalElement - 表示するモーダル要素
             */
            function showModal(modalElement) {
                modalElement.classList.add('show');
            }

            /**
             * モーダルを非表示にする
             * @param {HTMLElement} modalElement - 非表示にするモーダル要素
             */
            function hideModal(modalElement) {
                modalElement.classList.remove('show');
            }

            /**
             * カスタム確認モーダルを表示する
             * @param {string} message - 表示するメッセージ
             * @returns {Promise<boolean>} - ユーザーの選択 (true: はい, false: いいえ)
             */
            function showConfirmModal(message) {
                return new Promise(resolve => {
                    confirmMessage.textContent = message;
                    showModal(confirmModal);

                    const handleConfirm = (result) => {
                        hideModal(confirmModal);
                        confirmYesButton.removeEventListener('click', yesListener);
                        confirmNoButton.removeEventListener('click', noListener);
                        resolve(result);
                    };

                    const yesListener = () => handleConfirm(true);
                    const noListener = () => handleConfirm(false);

                    confirmYesButton.addEventListener('click', yesListener);
                    confirmNoButton.addEventListener('click', noListener);
                });
            }

            /**
             * 全てのスコアとプレイヤー名をリセットする
             */
            async function resetScores() {
                const confirmed = await showConfirmModal('全てのスコアとプレイヤー名をリセットしますか？この操作は元に戻せません。');
                if (confirmed) {
                    localStorage.removeItem(LOCAL_STORAGE_KEY_SCORES);
                    localStorage.removeItem(LOCAL_STORAGE_KEY_POINTS); // 点数設定もリセット
                    localStorage.removeItem(LOCAL_STORAGE_KEY_PLAYER_COUNT); // プレイヤー人数もリセット

                    // デフォルト値で初期化
                    scores = {
                        playerNames: [],
                        holeScores: Array(NUM_HOLES).fill(null).map(() => Array(MAX_PLAYERS).fill(''))
                    };
                    currentMedalPoints = { ...DEFAULT_MEDAL_POINTS };
                    currentPlayerCount = 4; // デフォルト人数に戻す

                    // UIもリセット
                    playerInputs.forEach((input, index) => {
                        input.value = `プレイヤー${String.fromCharCode(65 + index)}`;
                        scores.playerNames[index] = input.value;
                    });
                    // ラジオボタンもデフォルトに
                    playerCountRadios[2].checked = true; // 4人のラジオボタン

                    updatePlayerInputVisibility(); // プレイヤー入力欄の表示を更新
                    generateScoreTable();
                    updateResults();
                    populateSettingsModal(); // 設定モーダルも最新の状態に
                }
            }

            /**
             * メダル選択モーダル内のボタンクリックハンドラ
             */
            medalSelectModal.querySelectorAll('.modal-button').forEach(button => {
                button.addEventListener('click', () => {
                    if (currentSelectedCell) {
                        const holeIndex = parseInt(currentSelectedCell.dataset.hole);
                        const playerIndex = parseInt(currentSelectedCell.dataset.player);
                        const selectedMedal = button.dataset.medal;

                        scores.holeScores[holeIndex][playerIndex] = selectedMedal; // メダル種別を保存
                        currentSelectedCell.textContent = selectedMedal || '-'; // セルの表示を更新

                        // セルの背景色をリセットしてから新しいメダルに応じて色付け
                        currentSelectedCell.classList.remove('bg-yellow-100', 'bg-amber-100', 'bg-gray-200', 'bg-orange-100', 'bg-red-100');
                        if (selectedMedal === 'チップイン') currentSelectedCell.classList.add('bg-yellow-100');
                        else if (selectedMedal === '金') currentSelectedCell.classList.add('bg-amber-100');
                        else if (selectedMedal === '銀') currentSelectedCell.classList.add('bg-gray-200');
                        else if (selectedMedal === '銅') currentSelectedCell.classList.add('bg-orange-100');
                        else if (selectedMedal === '鉄') currentSelectedCell.classList.add('bg-red-100');

                        saveData(); // 変更があったら即座に保存
                        updateResults(); // 結果を更新
                        hideModal(medalSelectModal);
                        currentSelectedCell = null; // 選択セルをクリア
                    }
                });
            });

            // メダル選択モーダルの閉じるボタン
            closeMedalSelectModalButton.addEventListener('click', () => {
                hideModal(medalSelectModal);
                currentSelectedCell = null;
            });

            // 設定モーダルを開くボタン
            settingsButton.addEventListener('click', () => {
                populateSettingsModal();
                showModal(settingsModal);
            });

            // 設定モーダルを閉じるボタン
            closeSettingsModalButton.addEventListener('click', () => {
                hideModal(settingsModal);
            });

            /**
             * 設定モーダルに現在のメダル点数を表示する
             */
            function populateSettingsModal() {
                Object.keys(medalPointInputs).forEach(medal => {
                    if (medalPointInputs[medal]) {
                        medalPointInputs[medal].value = currentMedalPoints[medal];
                    }
                });
            }

            // 設定を保存するボタン
            saveSettingsButton.addEventListener('click', () => {
                let pointsChanged = false;
                Object.keys(medalPointInputs).forEach(medal => {
                    if (medalPointInputs[medal]) {
                        const newValue = parseInt(medalPointInputs[medal].value);
                        if (!isNaN(newValue) && currentMedalPoints[medal] !== newValue) {
                            currentMedalPoints[medal] = newValue;
                            pointsChanged = true;
                        }
                    }
                });

                if (pointsChanged) {
                    saveData(); // 点数設定を保存
                    updateResults(); // 点数が変わったので結果を再計算
                }
                hideModal(settingsModal);
            });

            // イベントリスナーの登録
            playerInputs.forEach(input => {
                input.addEventListener('input', () => { // 入力時に即座に保存し、UIを更新
                    saveData();
                    generateScoreTable(); // ヘッダーのプレイヤー名を更新するため
                    updateResults();
                });
            });
            resetButton.addEventListener('click', resetScores);

            // プレイヤー人数選択ラジオボタンのイベントリスナー
            playerCountRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    currentPlayerCount = parseInt(event.target.value);
                    saveData(); // 人数設定を保存
                    updatePlayerInputVisibility(); // プレイヤー入力欄の表示を更新
                    generateScoreTable(); // テーブルを再生成
                    updateResults(); // 結果を再計算・表示
                });
            });

            // ページの初期ロード時に実行
            loadData(); // スコア、点数設定、プレイヤー人数をロード
            updatePlayerInputVisibility(); // プレイヤー入力欄の表示を初期化
            generateScoreTable(); // まずテーブルを生成してから
            updateResults();     // 結果を計算・表示
        });
    </script>
</body>
</html>
